<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maze Chase üéÆ</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07071a;--bg2:#0e0e2a;--bg3:#16163a;--border:#2a2a5a;
  --accent:#f5c518;--accent2:#e8306a;--green:#00e676;--purple:#7c4dff;
  --text:#e8e8f0;--muted:#666688;
  --zA:#ff4455;--zB:#448aff;--zC:#00cc66;--zD:#ff9900;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--bg);
  background-image:radial-gradient(ellipse at 20% 20%,rgba(124,77,255,.14) 0%,transparent 55%),
                   radial-gradient(ellipse at 80% 80%,rgba(68,138,255,.11) 0%,transparent 55%);
  font-family:'Rajdhani',sans-serif;color:var(--text);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;}
.screen{display:none;width:100%;max-width:760px;flex-direction:column;align-items:center;padding:20px 16px;}
.screen.active{display:flex;}
.btn{padding:10px 22px;border:none;border-radius:6px;font-family:'Orbitron',sans-serif;
  font-size:.7rem;font-weight:700;cursor:pointer;letter-spacing:1px;text-transform:uppercase;
  transition:transform .08s,box-shadow .08s;outline:none;}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:translateY(1px);}
.btn-yellow{background:var(--accent);color:#000;box-shadow:0 4px 0 #a88200;}
.btn-yellow:hover{box-shadow:0 6px 0 #a88200;}
.btn-dark{background:var(--bg3);color:var(--text);border:1px solid var(--border);box-shadow:0 4px 0 #0a0a1a;}
.btn-dark:hover{border-color:var(--accent);}
.btn-red{background:var(--accent2);color:#fff;box-shadow:0 4px 0 #8a1040;}
.btn-green{background:#00a854;color:#fff;box-shadow:0 4px 0 #006030;}
.btn-sm{padding:6px 14px;font-size:.62rem;}
#menuScreen{gap:16px;padding-top:36px;}
.game-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:2.6rem;color:var(--accent);
  text-shadow:0 0 24px rgba(245,197,24,.5),3px 3px 0 #8a6200;letter-spacing:3px;text-align:center;}
.game-sub{font-size:.88rem;color:var(--muted);text-align:center;letter-spacing:1px;margin-top:-6px;}
.topic-grid{display:flex;flex-direction:column;gap:8px;width:100%;max-width:500px;}
.topic-card{background:var(--bg2);border:2px solid var(--border);border-radius:10px;
  padding:12px 18px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;
  transition:border-color .2s,background .2s,transform .1s;}
.topic-card:hover{border-color:var(--accent);background:var(--bg3);transform:translateX(4px);}
.topic-card.selected{border-color:var(--accent);background:var(--bg3);}
.topic-name-text{font-size:1rem;font-weight:600;}
.topic-q-count{font-size:.75rem;color:var(--muted);}
.menu-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px;}
.settings-box{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px;width:100%;max-width:500px;}
.settings-box h3{font-family:'Orbitron',sans-serif;font-size:.7rem;color:var(--accent);margin-bottom:14px;}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.setting-row:last-child{border-bottom:none;}
.setting-label{font-size:.88rem;}
.toggle{position:relative;width:44px;height:24px;}
.toggle input{display:none;}
.slider{position:absolute;inset:0;background:var(--border);border-radius:12px;cursor:pointer;transition:background .25s;}
.slider::before{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .25s;}
.toggle input:checked+.slider{background:var(--accent);}
.toggle input:checked+.slider::before{transform:translateX(20px);}
.stars{display:flex;gap:4px;}
.star{font-size:1.1rem;cursor:pointer;transition:transform .1s;opacity:.3;}
.star.lit{opacity:1;}
.star:hover{transform:scale(1.2);}
.num-input{width:56px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:.9rem;text-align:center;}
#manageScreen{gap:16px;align-items:stretch;}
.manage-header{display:flex;justify-content:space-between;align-items:center;}
.page-title{font-family:'Orbitron',sans-serif;font-size:.85rem;color:var(--accent);letter-spacing:2px;}
.topic-section{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.topic-sec-header{background:var(--bg3);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.topic-sec-name{font-size:1rem;font-weight:700;color:var(--accent);}
.topic-sec-btns{display:flex;gap:6px;}
.q-list{padding:10px;}
.q-item{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.q-item:last-child{margin-bottom:0;}
.q-info{flex:1;}
.q-text{font-size:.85rem;font-weight:600;margin-bottom:4px;}
.q-answers{font-size:.72rem;color:var(--muted);}
.q-correct{color:var(--green);}
.q-btns{display:flex;flex-direction:column;gap:4px;}
.no-questions{padding:12px;font-size:.8rem;color:var(--muted);text-align:center;}
.add-q-btn{width:100%;padding:10px;margin-top:6px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:2px solid var(--accent);border-radius:14px;padding:28px;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;}
.modal h2{font-family:'Orbitron',sans-serif;font-size:.85rem;color:var(--accent);margin-bottom:20px;}
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.form-group input,.form-group textarea{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s;}
.form-group input:focus,.form-group textarea:focus{border-color:var(--accent);}
.form-group textarea{resize:vertical;min-height:70px;}
.ans-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.ans-tag{font-family:'Orbitron',sans-serif;font-size:.65rem;width:20px;font-weight:700;}
.ans-radio{cursor:pointer;width:16px;height:16px;accent-color:var(--accent);}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;}
#gameScreen{padding:0;gap:0;align-items:center;justify-content:flex-start;}
.game-hud{width:100%;max-width:760px;background:rgba(7,7,26,.97);border-bottom:2px solid var(--border);padding:10px 14px;display:flex;flex-direction:column;gap:6px;}
.hud-row1{display:flex;justify-content:space-between;align-items:center;}
.hud-topic{font-family:'Orbitron',sans-serif;font-size:.58rem;color:var(--muted);letter-spacing:1px;}
.hud-timer{font-family:'Orbitron',sans-serif;font-size:.8rem;color:var(--accent);}
.hud-question{font-size:.92rem;font-weight:600;text-align:center;line-height:1.4;min-height:2.4em;}
.zone-labels{display:flex;justify-content:space-around;font-size:.7rem;font-weight:600;}
.zone-label{display:flex;align-items:center;gap:4px;max-width:24%;}
.zone-dot{width:9px;height:9px;border-radius:2px;flex-shrink:0;}
.zone-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hud-row3{display:flex;justify-content:space-between;align-items:center;font-size:.78rem;font-weight:600;}
.hud-lives{color:#ff4444;}
.hud-progress{color:var(--green);}
.hud-understanding{color:var(--purple);}
#gameCanvas{display:block;max-width:760px;width:100%;cursor:none;}
#answerOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.83);z-index:100;
  flex-direction:column;align-items:center;justify-content:center;gap:16px;backdrop-filter:blur(6px);}
#answerOverlay.open{display:flex;}
.ans-result-icon{font-size:4rem;animation:popIn .4s cubic-bezier(.175,.885,.32,1.275);}
@keyframes popIn{from{transform:scale(0);}to{transform:scale(1);}}
.ans-result-text{font-family:'Orbitron',sans-serif;font-size:1.4rem;font-weight:900;}
.ans-result-text.correct{color:var(--green);text-shadow:0 0 20px var(--green);}
.ans-result-text.incorrect{color:var(--accent2);text-shadow:0 0 20px var(--accent2);}
.ans-info{font-size:.88rem;color:var(--muted);text-align:center;max-width:340px;line-height:1.5;}
.understanding-label{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.understanding-track{background:var(--bg3);border:1px solid var(--border);border-radius:20px;width:300px;height:28px;overflow:hidden;}
.understanding-fill{height:100%;background:linear-gradient(90deg,#7c4dff,#448aff);border-radius:20px;
  transition:width .7s cubic-bezier(.25,.46,.45,.94);display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',sans-serif;font-size:.62rem;font-weight:700;min-width:36px;}
#resultScreen{gap:20px;padding-top:50px;text-align:center;}
.result-trophy{font-size:5rem;animation:float 2s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-12px);}}
.result-headline{font-family:'Orbitron',sans-serif;font-size:2rem;font-weight:900;color:var(--accent);text-shadow:0 0 30px rgba(245,197,24,.5);}
.result-pct{font-family:'Orbitron',sans-serif;font-size:3.5rem;font-weight:900;background:linear-gradient(135deg,#7c4dff,#448aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.result-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px 24px;width:100%;max-width:360px;}
.result-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:.9rem;}
.result-row:last-child{border-bottom:none;}
.result-key{color:var(--muted);}
.result-val{font-weight:700;color:var(--accent);}
.result-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* QUESTION PREVIEW OVERLAY */
#questionPreview{
  display:none;position:fixed;inset:0;z-index:150;
  background:rgba(4,4,22,.96);backdrop-filter:blur(8px);
  flex-direction:column;align-items:center;justify-content:center;gap:20px;
  padding:24px 20px;
}
#questionPreview.open{display:flex;}
.qp-badge{
  font-family:'Orbitron',sans-serif;font-size:.62rem;letter-spacing:2px;
  color:var(--muted);text-transform:uppercase;
  background:var(--bg3);border:1px solid var(--border);
  padding:5px 14px;border-radius:20px;
}
.qp-question{
  font-size:1.28rem;font-weight:700;text-align:center;
  max-width:560px;line-height:1.5;color:var(--text);
  animation:qpFadeIn .4s ease;
}
@keyframes qpFadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.qp-choices{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  width:100%;max-width:560px;
}
.qp-choice{
  display:flex;align-items:center;gap:12px;
  background:var(--bg2);border:2px solid var(--border);
  border-radius:10px;padding:12px 16px;
  animation:qpFadeIn .4s ease both;
}
.qp-choice:nth-child(1){animation-delay:.05s;border-color:rgba(255,68,85,.35);}
.qp-choice:nth-child(2){animation-delay:.1s; border-color:rgba(68,138,255,.35);}
.qp-choice:nth-child(3){animation-delay:.15s;border-color:rgba(0,204,102,.35);}
.qp-choice:nth-child(4){animation-delay:.2s; border-color:rgba(255,153,0,.35);}
.qp-letter{
  font-family:'Orbitron',sans-serif;font-weight:900;font-size:.85rem;
  width:28px;height:28px;border-radius:6px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;color:#000;
}
.qp-letter.a{background:var(--zA);}
.qp-letter.b{background:var(--zB);}
.qp-letter.c{background:var(--zC);}
.qp-letter.d{background:var(--zD);}
.qp-ans-text{font-size:.88rem;font-weight:600;color:var(--text);line-height:1.3;}
.qp-footer{display:flex;flex-direction:column;align-items:center;gap:8px;width:100%;max-width:560px;}
.qp-countdown-label{
  font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;
  color:var(--accent);letter-spacing:2px;
}
.qp-bar-track{
  width:100%;height:8px;background:var(--bg3);
  border:1px solid var(--border);border-radius:4px;overflow:hidden;
}
.qp-bar-fill{
  height:100%;width:100%;
  background:linear-gradient(90deg,var(--accent),#ff9900);
  border-radius:4px;
  transition:width .1s linear;
}
.qp-hint{font-size:.72rem;color:var(--muted);letter-spacing:.5px;}
</style>
</head>
<body>

<!-- MENU -->
<div id="menuScreen" class="screen active">
  <div class="game-title">‚ö° MAZE CHASE</div>
  <div class="game-sub">Run to the answer zone ¬∑ Avoid the enemies!</div>
  <div style="font-size:.78rem;color:var(--muted);margin-top:6px;align-self:flex-start;max-width:500px;width:100%;text-transform:uppercase;letter-spacing:1px;">üìö Choose a Topic</div>
  <div class="topic-grid" id="topicGrid"></div>
  <div class="menu-btns">
    <button class="btn btn-yellow" onclick="startGame()">‚ñ∂ Start Game</button>
    <button class="btn btn-dark" onclick="showScreen('manageScreen');renderManage();">‚öô Manage Topics</button>
    <button class="btn btn-dark" onclick="toggleSettings()">üîß Settings</button>
  </div>
  <div id="settingsPanel" class="settings-box" style="display:none;margin-top:12px;">
    <h3>‚öô GAME SETTINGS</h3>
    <div class="setting-row">
      <span class="setting-label">‚è± Timer Per Question</span>
      <label class="toggle"><input type="checkbox" id="timerToggle" checked onchange="applySettings()"><span class="slider"></span></label>
    </div>
    <div class="setting-row" id="timerSecRow">
      <span class="setting-label">‚è∞ Seconds Per Question</span>
      <input class="num-input" type="number" id="timerSecs" value="60" min="10" max="300" onchange="applySettings()">
    </div>
    <div class="setting-row">
      <span class="setting-label">üíÄ Enemy Difficulty</span>
      <div class="stars" id="diffStars"></div>
    </div>
    <div class="setting-row">
      <span class="setting-label">‚ù§ Lives Per Game</span>
      <input class="num-input" type="number" id="livesInput" value="3" min="1" max="12" onchange="applySettings()">
    </div>
    <div class="setting-row">
      <span class="setting-label">üëª Number of Enemies</span>
      <input class="num-input" type="number" id="enemyCount" value="3" min="1" max="5" onchange="applySettings()">
    </div>
  </div>
</div>

<!-- MANAGE -->
<div id="manageScreen" class="screen">
  <div class="manage-header" style="width:100%;">
    <button class="btn btn-dark btn-sm" onclick="showScreen('menuScreen')">‚Üê Back</button>
    <span class="page-title">üìö Manage Topics</span>
    <button class="btn btn-green btn-sm" onclick="openTopicModal(null)">+ Add Topic</button>
  </div>
  <div id="topicSections" style="width:100%;display:flex;flex-direction:column;gap:12px;margin-top:8px;"></div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <div class="game-hud">
    <div class="hud-row1">
      <span class="hud-topic" id="hudTopic">TOPIC</span>
      <span class="hud-timer" id="hudTimer">‚è± 60</span>
    </div>
    <div class="hud-question" id="hudQuestion">Loading...</div>
    <div class="zone-labels">
      <div class="zone-label"><div class="zone-dot" style="background:var(--zA)"></div><span class="zone-text" id="zoneA" style="color:var(--zA)"></span></div>
      <div class="zone-label"><div class="zone-dot" style="background:var(--zB)"></div><span class="zone-text" id="zoneB" style="color:var(--zB)"></span></div>
      <div class="zone-label"><div class="zone-dot" style="background:var(--zC)"></div><span class="zone-text" id="zoneC" style="color:var(--zC)"></span></div>
      <div class="zone-label"><div class="zone-dot" style="background:var(--zD)"></div><span class="zone-text" id="zoneD" style="color:var(--zD)"></span></div>
    </div>
    <div class="hud-row3">
      <span class="hud-lives" id="hudLives">‚ù§ ‚ù§ ‚ù§</span>
      <span class="hud-progress" id="hudProgress">üìù 1/5</span>
      <span class="hud-understanding" id="hudUnderstanding">üß† 0%</span>
    </div>
  </div>
  <canvas id="gameCanvas"></canvas>
</div>

<!-- QUESTION PREVIEW OVERLAY -->
<div id="questionPreview">
  <div class="qp-badge" id="qpBadge">Question 1 of 5</div>
  <div class="qp-question" id="qpQuestion">Loading question...</div>
  <div class="qp-choices">
    <div class="qp-choice">
      <div class="qp-letter a">A</div>
      <div class="qp-ans-text" id="qpA"></div>
    </div>
    <div class="qp-choice">
      <div class="qp-letter b">B</div>
      <div class="qp-ans-text" id="qpB"></div>
    </div>
    <div class="qp-choice">
      <div class="qp-letter c">C</div>
      <div class="qp-ans-text" id="qpC"></div>
    </div>
    <div class="qp-choice">
      <div class="qp-letter d">D</div>
      <div class="qp-ans-text" id="qpD"></div>
    </div>
  </div>
  <div class="qp-footer">
    <div class="qp-countdown-label" id="qpCountdown">Starting in 5...</div>
    <div class="qp-bar-track"><div class="qp-bar-fill" id="qpBarFill"></div></div>
    <div class="qp-hint">üëü Get ready to run to the correct zone!</div>
  </div>
</div>


<div id="answerOverlay">
  <div class="ans-result-icon" id="ansIcon">‚úÖ</div>
  <div class="ans-result-text" id="ansResultText">CORRECT!</div>
  <div class="ans-info" id="ansInfo"></div>
  <div class="understanding-label">Topic Understanding</div>
  <div class="understanding-track"><div class="understanding-fill" id="underFill" style="width:0%">0%</div></div>
  <button class="btn btn-yellow" id="nextQBtn" onclick="nextQuestion()">Next Question ‚Üí</button>
</div>

<!-- RESULT -->
<div id="resultScreen" class="screen">
  <div class="result-trophy" id="resultTrophy">üèÜ</div>
  <div class="result-headline" id="resultHeadline">YOU WIN!</div>
  <div class="result-pct" id="resultPct">0%</div>
  <div style="font-size:.8rem;color:var(--muted);margin-top:-12px;">Topic Understanding</div>
  <div class="result-table">
    <div class="result-row"><span class="result-key">Topic</span><span class="result-val" id="rTopic">‚Äî</span></div>
    <div class="result-row"><span class="result-key">Correct Answers</span><span class="result-val" id="rCorrect">‚Äî</span></div>
    <div class="result-row"><span class="result-key">Total Questions</span><span class="result-val" id="rTotal">‚Äî</span></div>
    <div class="result-row"><span class="result-key">Lives Remaining</span><span class="result-val" id="rLives">‚Äî</span></div>
  </div>
  <div class="result-btns">
    <button class="btn btn-yellow" onclick="startGame()">üîÑ Play Again</button>
    <button class="btn btn-dark" onclick="showScreen('menuScreen')">üè† Main Menu</button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="topicModalOverlay">
  <div class="modal">
    <h2 id="topicModalTitle">ADD TOPIC</h2>
    <div class="form-group"><label>Topic Name</label><input type="text" id="topicNameInput" placeholder="e.g. Marine Ecosystem"></div>
    <div class="modal-btns">
      <button class="btn btn-dark btn-sm" onclick="closeModal('topicModalOverlay')">Cancel</button>
      <button class="btn btn-yellow btn-sm" onclick="saveTopic()">Save</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="questionModalOverlay">
  <div class="modal">
    <h2 id="questionModalTitle">ADD QUESTION</h2>
    <div class="form-group"><label>Question Text</label><textarea id="qTextInput" placeholder="Type your question here..."></textarea></div>
    <div class="form-group">
      <label>Answers ¬∑ Click ‚óè to mark the correct one</label>
      <div class="ans-row"><span class="ans-tag" style="color:var(--zA)">A</span><input type="text" id="ai0" placeholder="Answer A"><input type="radio" name="correctAns" value="0" class="ans-radio" checked></div>
      <div class="ans-row"><span class="ans-tag" style="color:var(--zB)">B</span><input type="text" id="ai1" placeholder="Answer B"><input type="radio" name="correctAns" value="1" class="ans-radio"></div>
      <div class="ans-row"><span class="ans-tag" style="color:var(--zC)">C</span><input type="text" id="ai2" placeholder="Answer C"><input type="radio" name="correctAns" value="2" class="ans-radio"></div>
      <div class="ans-row"><span class="ans-tag" style="color:var(--zD)">D</span><input type="text" id="ai3" placeholder="Answer D"><input type="radio" name="correctAns" value="3" class="ans-radio"></div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-dark btn-sm" onclick="closeModal('questionModalOverlay')">Cancel</button>
      <button class="btn btn-yellow btn-sm" onclick="saveQuestion()">Save</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STORE_KEY='mazeChaseData_v3';
function loadData(){try{const r=localStorage.getItem(STORE_KEY);if(r)return JSON.parse(r);}catch(e){}return{topics:defaultTopics()};}
function saveData(){localStorage.setItem(STORE_KEY,JSON.stringify(appData));}
function uid(){return Math.random().toString(36).slice(2,10);}
function defaultTopics(){return[
  {id:uid(),name:'Marine Ecosystem',questions:[
    {id:uid(),q:'What is the largest ocean on Earth?',a:['Atlantic Ocean','Pacific Ocean','Indian Ocean','Arctic Ocean'],correct:1},
    {id:uid(),q:'Which animal is a marine mammal?',a:['Shark','Tuna','Dolphin','Jellyfish'],correct:2},
    {id:uid(),q:'What do coral reefs primarily provide?',a:['Drinking water','Habitat for sea life','Desert sand','Crude oil'],correct:1},
    {id:uid(),q:'What process do sea plants use to make food from sunlight?',a:['Respiration','Evaporation','Photosynthesis','Decomposition'],correct:2},
    {id:uid(),q:'Which is a major threat to marine ecosystems?',a:['Snorkeling','Plastic pollution','Swimming','Sailing slowly'],correct:1},
  ]},
  {id:uid(),name:'Sentence Types',questions:[
    {id:uid(),q:'"What time is it?" ‚Äî what sentence type?',a:['Declarative','Interrogative','Imperative','Exclamatory'],correct:1},
    {id:uid(),q:'"Stop right there!" ‚Äî what sentence type?',a:['Declarative','Interrogative','Imperative','Exclamatory'],correct:2},
    {id:uid(),q:'"The sky is blue." ‚Äî what sentence type?',a:['Declarative','Interrogative','Imperative','Exclamatory'],correct:0},
    {id:uid(),q:'"What an amazing view!" ‚Äî what sentence type?',a:['Declarative','Interrogative','Imperative','Exclamatory'],correct:3},
  ]},
];}
let appData=loadData();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const settings={timerEnabled:true,timerSecs:60,difficulty:3,lives:3,enemyCount:3};
function applySettings(){
  settings.timerEnabled=document.getElementById('timerToggle').checked;
  settings.timerSecs=parseInt(document.getElementById('timerSecs').value)||60;
  settings.lives=parseInt(document.getElementById('livesInput').value)||3;
  settings.enemyCount=parseInt(document.getElementById('enemyCount').value)||3;
  document.getElementById('timerSecRow').style.display=settings.timerEnabled?'':'none';
}
function buildDiffStars(){
  const el=document.getElementById('diffStars');el.innerHTML='';
  for(let i=1;i<=5;i++){const s=document.createElement('span');s.className='star'+(i<=settings.difficulty?' lit':'');s.textContent='‚òÖ';s.onclick=()=>{settings.difficulty=i;buildDiffStars();};el.appendChild(s);}
}
buildDiffStars();
function toggleSettings(){const p=document.getElementById('settingsPanel');p.style.display=p.style.display==='none'?'':'none';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='menuScreen')renderMenu();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let selectedTopicId=null;
function renderMenu(){
  const g=document.getElementById('topicGrid');g.innerHTML='';
  if(!appData.topics.length){g.innerHTML='<div style="color:var(--muted);font-size:.85rem;padding:12px;">No topics ‚Äî click ‚öô Manage Topics!</div>';return;}
  appData.topics.forEach(t=>{
    const el=document.createElement('div');el.className='topic-card'+(t.id===selectedTopicId?' selected':'');
    el.innerHTML=`<span class="topic-name-text">${t.name}</span><span class="topic-q-count">${t.questions.length} Q</span>`;
    el.onclick=()=>{selectedTopicId=t.id;document.querySelectorAll('.topic-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');};
    g.appendChild(el);
  });
  if(!selectedTopicId&&appData.topics.length)selectedTopicId=appData.topics[0].id;
}
renderMenu();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let editingTopicId=null,editingQuestionId=null,editingQTopicId=null;
function renderManage(){
  const c=document.getElementById('topicSections');c.innerHTML='';
  if(!appData.topics.length){c.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px;">No topics yet.</div>';return;}
  appData.topics.forEach(topic=>{
    const sec=document.createElement('div');sec.className='topic-section';
    const qHTML=topic.questions.length===0?'<div class="no-questions">No questions yet.</div>':
      topic.questions.map((q,i)=>`<div class="q-item"><div class="q-info"><div class="q-text">${i+1}. ${q.q}</div><div class="q-answers">${q.a.map((ans,ai)=>`<span${ai===q.correct?' class="q-correct"':''}>${'ABCD'[ai]}: ${ans}</span>`).join(' ¬∑ ')}</div></div><div class="q-btns"><button class="btn btn-dark btn-sm" onclick="openQuestionModal('${topic.id}','${q.id}')">‚úè</button><button class="btn btn-red btn-sm" onclick="deleteQuestion('${topic.id}','${q.id}')">üóë</button></div></div>`).join('');
    sec.innerHTML=`<div class="topic-sec-header"><span class="topic-sec-name">${topic.name}</span><div class="topic-sec-btns"><button class="btn btn-dark btn-sm" onclick="openTopicModal('${topic.id}')">‚úè Edit</button><button class="btn btn-red btn-sm" onclick="deleteTopic('${topic.id}')">üóë Delete</button></div></div><div class="q-list">${qHTML}<button class="btn btn-green btn-sm add-q-btn" onclick="openQuestionModal('${topic.id}',null)">+ Add Question</button></div>`;
    c.appendChild(sec);
  });
}
function openTopicModal(tid){editingTopicId=tid;const t=tid?appData.topics.find(t=>t.id===tid):null;document.getElementById('topicModalTitle').textContent=tid?'EDIT TOPIC':'ADD TOPIC';document.getElementById('topicNameInput').value=t?t.name:'';document.getElementById('topicModalOverlay').classList.add('open');}
function saveTopic(){const name=document.getElementById('topicNameInput').value.trim();if(!name)return alert('Name required.');if(editingTopicId){const t=appData.topics.find(t=>t.id===editingTopicId);if(t)t.name=name;}else appData.topics.push({id:uid(),name,questions:[]});saveData();closeModal('topicModalOverlay');renderManage();renderMenu();}
function deleteTopic(id){if(!confirm('Delete this topic and all its questions?'))return;appData.topics=appData.topics.filter(t=>t.id!==id);if(selectedTopicId===id)selectedTopicId=appData.topics[0]?.id||null;saveData();renderManage();renderMenu();}
function openQuestionModal(topicId,questionId){
  editingQTopicId=topicId;editingQuestionId=questionId;
  const topic=appData.topics.find(t=>t.id===topicId),q=questionId?topic.questions.find(q=>q.id===questionId):null;
  document.getElementById('questionModalTitle').textContent=questionId?'EDIT QUESTION':'ADD QUESTION';
  document.getElementById('qTextInput').value=q?q.q:'';
  ['ai0','ai1','ai2','ai3'].forEach((id,i)=>document.getElementById(id).value=q?(q.a[i]||''):'');
  document.querySelectorAll('input[name="correctAns"]').forEach(r=>r.checked=q?(+r.value===q.correct):(r.value==='0'));
  document.getElementById('questionModalOverlay').classList.add('open');
}
function saveQuestion(){
  const qText=document.getElementById('qTextInput').value.trim();
  const answers=['ai0','ai1','ai2','ai3'].map(id=>document.getElementById(id).value.trim());
  const correct=+[...document.querySelectorAll('input[name="correctAns"]')].find(r=>r.checked).value;
  if(!qText)return alert('Question text required.');
  if(answers.some(a=>!a))return alert('All 4 answers required.');
  const topic=appData.topics.find(t=>t.id===editingQTopicId);
  if(editingQuestionId){const q=topic.questions.find(q=>q.id===editingQuestionId);if(q){q.q=qText;q.a=answers;q.correct=correct;}}
  else topic.questions.push({id:uid(),q:qText,a:answers,correct});
  saveData();closeModal('questionModalOverlay');renderManage();
}
function deleteQuestion(tid,qid){if(!confirm('Delete this question?'))return;const t=appData.topics.find(t=>t.id===tid);t.questions=t.questions.filter(q=>q.id!==qid);saveData();renderManage();}
function closeModal(id){document.getElementById(id).classList.remove('open');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAZE  37 √ó 29  TILE=20  ‚Üí  740 √ó 580 px

   Zone boxes (6√ó6 tiles each, set LAST to override):
     A  cols 1-6   rows 1-6   top-left
     B  cols 30-35 rows 1-6   top-right
     C  cols 1-6   rows 22-27 bot-left
     D  cols 30-35 rows 22-27 bot-right

   Outer ring:  row 7 / row 21 / col 7 / col 29
   Center cross: col 18 (rows 1-27) + row 14 (cols 7-29)
   Player spawns at col 18, row 14  (exact center)

   Enemy spawns ‚Äî ALL are on the outer ring corners,
   minimum 11 tiles from center:
     E0 (7,7)   E1 (29,7)   E2 (7,21)   E3 (29,21)
     E4 (18,7)  ‚Äî top of center column, 7 rows from center
   
   Patrol loops stay within each quadrant's outer corner.
   No patrol waypoint is within 5 tiles of (18,14).
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COLS=37, ROWS=29, TILE=20;
const CW=COLS*TILE, CH=ROWS*TILE; // 740 √ó 580
const T_WALL=0,T_PATH=1,T_A=2,T_B=3,T_C=4,T_D=5;

const ZONE_COLORS=['#ff4455','#448aff','#00cc66','#ff9900'];
const ZONE_GLOW=['rgba(255,68,85,.75)','rgba(68,138,255,.75)','rgba(0,204,102,.75)','rgba(255,153,0,.75)'];

const ZONE_BOXES=[
  {zi:0,c1:1, r1:1, c2:6, r2:6},
  {zi:1,c1:30,r1:1, c2:35,r2:6},
  {zi:2,c1:1, r1:22,c2:6, r2:27},
  {zi:3,c1:30,r1:22,c2:35,r2:27},
];

function buildMap(){
  const m=Array.from({length:ROWS},()=>new Array(COLS).fill(T_WALL));
  const h=(r,c1,c2)=>{for(let c=c1;c<=c2;c++)if(r>=0&&r<ROWS&&c>=0&&c<COLS)m[r][c]=T_PATH;};
  const v=(c,r1,r2)=>{for(let r=r1;r<=r2;r++)if(r>=0&&r<ROWS&&c>=0&&c<COLS)m[r][c]=T_PATH;};
  const box=(c1,r1,c2,r2,t)=>{for(let r=r1;r<=r2;r++)for(let c=c1;c<=c2;c++)m[r][c]=t;};

  // ‚îÄ‚îÄ OUTER RING ‚îÄ‚îÄ
  h(7, 1,35);   h(21,1,35);
  v(7, 7,21);   v(29,7,21);

  // ‚îÄ‚îÄ CENTER CROSS ‚îÄ‚îÄ
  v(18,1,27);   // center vertical ‚Äî full height (col 18)
  h(14,7,29);   // center horizontal ‚Äî full width (row 14)

  // ‚îÄ‚îÄ INNER HORIZONTAL CORRIDORS ‚îÄ‚îÄ
  h(10,7,29);   // upper-inner H
  h(18,7,29);   // lower-inner H

  // ‚îÄ‚îÄ INNER VERTICAL CORRIDORS ‚îÄ‚îÄ
  v(11,7,21);   v(25,7,21);
  v(14,7,21);   v(22,7,21);

  // ‚îÄ‚îÄ POCKET ROOMS ‚Äî small 3√ó3 loops in each quadrant corner ‚îÄ‚îÄ
  // top-left pocket
  h(9, 8,10);  v(9, 7,10);  v(10,7,10);
  // top-right pocket
  h(9,26,28);  v(27,7,10);  v(28,7,10);
  // bot-left pocket
  h(19,8,10);  v(9,18,21);  v(10,18,21);
  // bot-right pocket
  h(19,26,28); v(27,18,21); v(28,18,21);

  // ‚îÄ‚îÄ INNER LOOP SEGMENTS ‚Äî S-shaped routes through interior ‚îÄ‚îÄ
  h(12,11,14); h(12,22,25);
  h(16,11,14); h(16,22,25);
  v(13,10,18); v(23,10,18);

  // ‚îÄ‚îÄ CENTRAL BRIDGES ‚îÄ‚îÄ
  h(12,14,22);  h(16,14,22);

  // ‚îÄ‚îÄ CENTER VERTICAL EXTENSIONS into zone gap ‚îÄ‚îÄ
  v(18,1,6);    v(18,22,27);

  // ‚îÄ‚îÄ SHORT BRANCH CORRIDORS off main arteries ‚îÄ‚îÄ
  h(5, 7,11);  h(5, 25,29);   // top branches
  h(23,7,11);  h(23,25,29);   // bot branches
  v(11,1,7);   v(25,1,7);     // connect top-zone edge to outer ring
  v(11,21,27); v(25,21,27);   // connect bot-zone edge to outer ring

  // ‚îÄ‚îÄ ZONE BOXES (set last ‚Äî overwrite corridors inside boxes) ‚îÄ‚îÄ
  box(1,1,6,6,T_A);
  box(30,1,35,6,T_B);
  box(1,22,6,27,T_C);
  box(30,22,35,27,T_D);

  return m;
}

function getCell(r,c){if(r<0||r>=ROWS||c<0||c>=COLS)return T_WALL;return MAP[r][c];}
function isWalkable(t){return t!==T_WALL;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BFS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function bfs(sc,sr,ec,er){
  if(sc===ec&&sr===er)return[];
  const q=[[sc,sr]],vis=new Set([sc+','+sr]),par={};
  while(q.length){
    const[c,r]=q.shift();
    if(c===ec&&r===er){
      const path=[];let k=c+','+r;
      while(par[k]){const[pc,pr]=par[k];path.unshift({tc:pc,tr:pr});k=pc+','+pr;}
      path.push({tc:ec,tr:er});return path;
    }
    for(const[dc,dr]of[[0,1],[0,-1],[1,0],[-1,0]]){
      const nc=c+dc,nr=r+dr,key=nc+','+nr;
      if(!vis.has(key)&&nc>=0&&nc<COLS&&nr>=0&&nr<ROWS&&isWalkable(MAP[nr][nc])){vis.add(key);par[key]=[c,r];q.push([nc,nr]);}
    }
  }
  return[];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENEMY CONFIG
   
   All spawns on outer ring corners ‚Äî 11+ tiles from player (18,14).
   Patrol loops: tight rectangles in each quadrant corner.
   Waypoints use the outer ring (row 7/21, col 7/29) and inner
   corridors (rows 10/18, cols 11/25) ‚Äî none pass through (18,14).
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PLAYER_SPAWN_COL=18, PLAYER_SPAWN_ROW=14;
const PATROL_DELAY=5.5;   // seconds before chasing starts
const SPAWN_PROTECT=2.0;  // seconds of invincibility at round start

const ENEMY_SPAWNS=[
  {tc:7, tr:7},   // E0  top-left  outer corner
  {tc:29,tr:7},   // E1  top-right outer corner
  {tc:7, tr:21},  // E2  bot-left  outer corner
  {tc:29,tr:21},  // E3  bot-right outer corner
  {tc:7, tr:14},  // E4  left-center on outer ring (col 7, row 14) ‚Äî 11 tiles away
];
const ENEMY_COLORS=['#cc44ff','#ff7722','#22dde8','#ff4488','#88ff33'];

// Patrol loops ‚Äî all waypoints are on verified corridor tiles, ‚â•5 tiles from (18,14)
const PATROL_LOOPS=[
  // E0 top-left  cols 7-11 rows 7-10 (outer ring corner + inner verticals)
  [{tc:7,tr:7},{tc:11,tr:7},{tc:11,tr:10},{tc:7,tr:10}],
  // E1 top-right cols 25-29 rows 7-10
  [{tc:29,tr:7},{tc:25,tr:7},{tc:25,tr:10},{tc:29,tr:10}],
  // E2 bot-left  cols 7-11 rows 18-21
  [{tc:7,tr:21},{tc:7,tr:18},{tc:11,tr:18},{tc:11,tr:21}],
  // E3 bot-right cols 25-29 rows 18-21
  [{tc:29,tr:21},{tc:29,tr:18},{tc:25,tr:18},{tc:25,tr:21}],
  // E4 left side: walks up and down col 7 between rows 7 and 21
  [{tc:7,tr:14},{tc:7,tr:7},{tc:11,tr:7},{tc:11,tr:10},{tc:7,tr:10},{tc:7,tr:21},{tc:11,tr:21},{tc:11,tr:18},{tc:7,tr:18}],
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let MAP=null, G={}, canvas, ctx;

function initGame(){
  if(!MAP)MAP=buildMap();
  const topic=appData.topics.find(t=>t.id===selectedTopicId);
  if(!topic||!topic.questions.length)return false;

  // Speed: diff1‚Üí0.26, diff3‚Üí0.42, diff5‚Üí0.58  (pixels per frame √ó step multiplier)
  const spd=0.18+settings.difficulty*0.08;
  const enemies=[];
  for(let i=0;i<Math.min(settings.enemyCount,5);i++){
    const sp=ENEMY_SPAWNS[i];
    enemies.push({
      x:(sp.tc+.5)*TILE, y:(sp.tr+.5)*TILE,
      speed:spd, path:[], pathTimer:0,
      patrolPath:[], patrolIdx:0,
      bob:i*1.3, color:ENEMY_COLORS[i], mode:'patrol',
    });
  }
  G={
    topic,
    questions:[...topic.questions].sort(()=>Math.random()-.5),
    qIndex:0, correctCount:0,
    lives:settings.lives, maxLives:settings.lives,
    timerLeft:settings.timerSecs, timerEnabled:settings.timerEnabled,
    player:{x:(PLAYER_SPAWN_COL+.5)*TILE,y:(PLAYER_SPAWN_ROW+.5)*TILE,vx:0,vy:0,size:TILE*.35},
    enemies, keys:{}, phase:'playing',
    hitCooldown:0, spawnProtect:SPAWN_PROTECT,
    tick:0, patrolTimer:0, chaseStarted:false,
    running:false, animId:null, lastTime:0, particles:[],
  };
  return true;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLLISION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tileAt(px,py){
  const tc=Math.floor(px/TILE),tr=Math.floor(py/TILE);
  if(tc<0||tc>=COLS||tr<0||tr>=ROWS)return T_WALL;
  return MAP[tr][tc];
}
function hitsWall(x,y,r){
  return tileAt(x-r,y-r)===T_WALL||tileAt(x+r,y-r)===T_WALL||
         tileAt(x-r,y+r)===T_WALL||tileAt(x+r,y+r)===T_WALL;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const INPUT_ACCEL=6.5,MAX_SPEED=3.5,FRICTION=0.72;

function loop(ts){
  if(!G.running)return;
  const dt=Math.min((ts-G.lastTime)/1000,.05);
  G.lastTime=ts;
  update(dt);
  render();
  G.animId=requestAnimationFrame(loop);
}

function update(dt){
  if(G.phase!=='playing')return;
  G.tick++;
  G.patrolTimer+=dt;
  if(G.spawnProtect>0)G.spawnProtect-=dt;
  if(!G.chaseStarted&&G.patrolTimer>PATROL_DELAY){
    G.chaseStarted=true;
    G.enemies.forEach(e=>{e.mode='chase';e.path=[];e.pathTimer=0;});
  }

  // Player movement
  const p=G.player;
  if(G.keys['ArrowLeft'] ||G.keys['KeyA']) p.vx-=INPUT_ACCEL;
  if(G.keys['ArrowRight']||G.keys['KeyD']) p.vx+=INPUT_ACCEL;
  if(G.keys['ArrowUp']   ||G.keys['KeyW']) p.vy-=INPUT_ACCEL;
  if(G.keys['ArrowDown'] ||G.keys['KeyS']) p.vy+=INPUT_ACCEL;
  p.vx=Math.max(-MAX_SPEED*2,Math.min(MAX_SPEED*2,p.vx));
  p.vy=Math.max(-MAX_SPEED*2,Math.min(MAX_SPEED*2,p.vy));

  // Tile-center snap for smooth corridor navigation
  const ax=Math.abs(p.vx),ay=Math.abs(p.vy);
  if(ax>0.3&&ax>=ay){const cy=(Math.floor(p.y/TILE)+.5)*TILE;p.y+=(cy-p.y)*.22;}
  if(ay>0.3&&ay> ax){const cx=(Math.floor(p.x/TILE)+.5)*TILE;p.x+=(cx-p.x)*.22;}

  const mr=p.size-2;
  if(!hitsWall(p.x+p.vx,p.y,mr))p.x+=p.vx; else p.vx*=-.3;
  if(!hitsWall(p.x,p.y+p.vy,mr))p.y+=p.vy; else p.vy*=-.3;
  p.vx*=FRICTION; p.vy*=FRICTION;
  p.x=Math.max(mr,Math.min(CW-mr,p.x));
  p.y=Math.max(mr,Math.min(CH-mr,p.y));

  // Timer
  if(G.timerEnabled){
    G.timerLeft-=dt;
    if(G.timerLeft<=0){G.timerLeft=0;loseLife();}
    const hudT=document.getElementById('hudTimer');
    hudT.textContent='‚è± '+Math.ceil(G.timerLeft)+'s';
    hudT.style.color=G.timerLeft<=10?'#ff4444':'var(--accent)';
  }

  // Zone detection
  const zone=tileAt(p.x,p.y);
  if(zone>=T_A&&zone<=T_D&&G.phase==='playing'){
    const zi=zone-T_A;
    const q=G.questions[G.qIndex];
    const correct=q.correct===zi;
    spawnParticles(p.x,p.y,correct?'#00ff88':'#ff4455',correct?18:10);
    showAnswerOverlay(correct,zi,q);
    G.phase='answered';
    return;
  }

  // Enemy update + collision
  for(const en of G.enemies){
    moveEnemy(en,dt);
    if(G.spawnProtect>0||G.hitCooldown>0)continue;
    const dx=en.x-p.x,dy=en.y-p.y;
    if(Math.sqrt(dx*dx+dy*dy)<p.size+TILE*.38){
      const d=Math.sqrt(dx*dx+dy*dy)||1;
      en.x+=(dx/d)*TILE*4; en.y+=(dy/d)*TILE*4;
      en.path=[]; en.patrolPath=[];
      spawnParticles(p.x,p.y,'#ff4444',12);
      G.hitCooldown=90;
      loseLife();
    }
  }

  G.particles=G.particles.filter(pt=>{pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=.09;pt.life-=.03;return pt.life>0;});
  if(G.hitCooldown>0)G.hitCooldown--;
  updateHud();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENEMY AI
   Patrol:  tight corner loops at half chase speed.
   Chase:   BFS to player, re-paths every ~0.5s.
   Speed is intentionally slow ‚Äî player is always 4-5√ó faster.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function moveEnemy(en,dt){
  en.pathTimer-=dt;
  const idx=G.enemies.indexOf(en);

  if(en.mode==='patrol'){
    if(!en.patrolPath||en.patrolPath.length===0){
      const loop=PATROL_LOOPS[idx%PATROL_LOOPS.length];
      const tgt=loop[en.patrolIdx%loop.length];
      const ec=Math.floor(en.x/TILE),er=Math.floor(en.y/TILE);
      if(ec===tgt.tc&&er===tgt.tr){en.patrolIdx++;return;}
      en.patrolPath=bfs(ec,er,tgt.tc,tgt.tr);
      if(!en.patrolPath.length){en.patrolIdx++;return;}
    }
    stepAlongPath(en,en.patrolPath,en.speed*TILE*0.055,()=>{en.patrolIdx++;en.patrolPath=[];});
  } else {
    if(en.pathTimer<=0){
      const ec=Math.floor(en.x/TILE),er=Math.floor(en.y/TILE);
      const pc=Math.floor(G.player.x/TILE),pr=Math.floor(G.player.y/TILE);
      en.path=bfs(ec,er,pc,pr);
      en.pathTimer=0.5-settings.difficulty*0.05;
    }
    stepAlongPath(en,en.path,en.speed*TILE*0.11,()=>{});
  }
}

function stepAlongPath(en,path,spd,onComplete){
  if(!path||path.length===0)return;
  const next=path[0];
  const tx=(next.tc+.5)*TILE,ty=(next.tr+.5)*TILE;
  const dx=tx-en.x,dy=ty-en.y,dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<=spd+0.5){path.shift();if(path.length===0)onComplete();}
  else{en.x+=dx/dist*spd;en.y+=dy/dist*spd;}
}

function loseLife(){
  G.lives--;
  G.timerLeft=settings.timerSecs;
  G.spawnProtect=1.5;
  updateHud();
  if(G.lives<=0){G.running=false;setTimeout(()=>showResult(false),500);}
}
function spawnParticles(x,y,color,n){
  for(let i=0;i<n;i++){const a=Math.PI*2/n*i+Math.random()*.4;const s=1.5+Math.random()*3.5;G.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1,life:1,color,size:2+Math.random()*4});}
}
function updateHud(){
  document.getElementById('hudLives').textContent='‚ù§ '.repeat(Math.max(0,G.lives)).trim()||'üíÄ';
  document.getElementById('hudProgress').textContent=`üìù ${G.qIndex+1}/${G.questions.length}`;
  document.getElementById('hudUnderstanding').textContent=`üß† ${Math.round(G.correctCount/G.questions.length*100)}%`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STARS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STARS=Array.from({length:90},()=>({
  x:Math.random()*CW,y:Math.random()*CH,
  r:.3+Math.random()*1.5,a:.25+Math.random()*.75,
  phase:Math.random()*Math.PI*2,spd:.01+Math.random()*.025,
}));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDERER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function render(){
  ctx.clearRect(0,0,CW,CH);

  // Space background
  const bg=ctx.createRadialGradient(CW*.5,CH*.4,0,CW*.5,CH*.5,CW*.8);
  bg.addColorStop(0,'#111345');bg.addColorStop(.5,'#090928');bg.addColorStop(1,'#04041a');
  ctx.fillStyle=bg;ctx.fillRect(0,0,CW,CH);

  for(const s of STARS){
    s.phase+=s.spd;
    ctx.globalAlpha=s.a*(.45+.55*Math.sin(s.phase));
    ctx.fillStyle='#c8d8ff';ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  drawTiles();
  drawGoldenBorders();
  drawZoneBoxes();
  drawArrows();

  // Particles
  for(const pt of G.particles){
    ctx.globalAlpha=pt.life*pt.life;ctx.fillStyle=pt.color;
    ctx.beginPath();ctx.arc(pt.x,pt.y,pt.size,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  for(const en of G.enemies)drawEnemy(en);
  drawPlayer();

  // Spawn-protection glow
  if(G.spawnProtect>0&&G.spawnProtect<SPAWN_PROTECT*.9){
    const alpha=.13*(1+Math.sin(G.tick*.45));
    ctx.fillStyle=`rgba(100,180,255,${alpha})`;
    ctx.beginPath();ctx.arc(G.player.x,G.player.y,TILE*1.7,0,Math.PI*2);ctx.fill();
  }

  // Pre-chase countdown
  if(!G.chaseStarted&&G.phase==='playing'){
    const secs=Math.ceil(PATROL_DELAY-G.patrolTimer);
    if(secs>0){
      ctx.fillStyle='rgba(255,210,50,.95)';
      ctx.font=`bold ${TILE*.58}px Orbitron,monospace`;
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowColor='rgba(255,150,0,.6)';ctx.shadowBlur=14;
      ctx.fillText(`üëª ENEMIES UNLEASHED IN ${secs}...`,CW/2,CH-TILE*1.4);
      ctx.shadowBlur=0;ctx.textAlign='left';ctx.textBaseline='top';
    }
  }
}

function drawTiles(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const t=MAP[r][c],x=c*TILE,y=r*TILE;
      if(t===T_WALL){
        ctx.fillStyle='#0b0b2e';ctx.fillRect(x,y,TILE,TILE);
        ctx.fillStyle='rgba(90,90,170,.1)';ctx.fillRect(x,y,TILE,2);ctx.fillRect(x,y,2,TILE);
      } else if(t===T_PATH){
        ctx.fillStyle='#141440';ctx.fillRect(x,y,TILE,TILE);
        ctx.fillStyle='rgba(80,80,180,.09)';ctx.fillRect(x+TILE/2-1,y+TILE/2-1,2,2);
      } else {
        const zi=t-T_A;
        ctx.fillStyle='#141440';ctx.fillRect(x,y,TILE,TILE);
        const pulse=.15+.12*Math.sin(G.tick*.05+zi*1.1);
        ctx.globalAlpha=pulse;ctx.fillStyle=ZONE_COLORS[zi];ctx.fillRect(x,y,TILE,TILE);ctx.globalAlpha=1;
      }
    }
  }
}

function drawGoldenBorders(){
  ctx.lineWidth=2;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(!isWalkable(MAP[r][c]))continue;
      const x=c*TILE,y=r*TILE;
      ctx.strokeStyle='#c88a10';
      if(!isWalkable(getCell(r-1,c))){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+TILE,y);ctx.stroke();}
      if(!isWalkable(getCell(r+1,c))){ctx.beginPath();ctx.moveTo(x,y+TILE);ctx.lineTo(x+TILE,y+TILE);ctx.stroke();}
      if(!isWalkable(getCell(r,c-1))){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x,y+TILE);ctx.stroke();}
      if(!isWalkable(getCell(r,c+1))){ctx.beginPath();ctx.moveTo(x+TILE,y);ctx.lineTo(x+TILE,y+TILE);ctx.stroke();}
    }
  }
  ctx.strokeStyle='rgba(220,155,30,.2)';ctx.lineWidth=4;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(!isWalkable(MAP[r][c]))continue;
      const x=c*TILE,y=r*TILE;
      if(!isWalkable(getCell(r-1,c))){ctx.beginPath();ctx.moveTo(x,y+1);ctx.lineTo(x+TILE,y+1);ctx.stroke();}
      if(!isWalkable(getCell(r+1,c))){ctx.beginPath();ctx.moveTo(x,y+TILE-1);ctx.lineTo(x+TILE,y+TILE-1);ctx.stroke();}
      if(!isWalkable(getCell(r,c-1))){ctx.beginPath();ctx.moveTo(x+1,y);ctx.lineTo(x+1,y+TILE);ctx.stroke();}
      if(!isWalkable(getCell(r,c+1))){ctx.beginPath();ctx.moveTo(x+TILE-1,y);ctx.lineTo(x+TILE-1,y+TILE);ctx.stroke();}
    }
  }
  ctx.lineWidth=1;
}

function drawZoneBoxes(){
  const q=G.questions[G.qIndex];
  ctx.textAlign='center';ctx.textBaseline='middle';
  for(const zb of ZONE_BOXES){
    const x1=zb.c1*TILE,y1=zb.r1*TILE,w=(zb.c2-zb.c1+1)*TILE,h=(zb.r2-zb.r1+1)*TILE;
    const cx=x1+w/2,cy=y1+h/2;
    const pulse=.5+.5*Math.sin(G.tick*.04+zb.zi*.9);
    ctx.shadowColor=ZONE_GLOW[zb.zi];ctx.shadowBlur=12+8*pulse;
    ctx.strokeStyle=ZONE_COLORS[zb.zi];ctx.lineWidth=2.5;
    ctx.strokeRect(x1+3,y1+3,w-6,h-6);
    ctx.shadowBlur=0;
    ctx.fillStyle='rgba(0,0,0,.38)';ctx.fillRect(x1+5,y1+5,w-10,h-10);
    ctx.fillStyle=ZONE_COLORS[zb.zi];ctx.font=`900 ${TILE*.65}px Orbitron,monospace`;
    ctx.fillText('ABCD'[zb.zi],cx-w*.19,cy);
    const ans=q?q.a[zb.zi]:'';
    ctx.fillStyle='#ffffff';ctx.font=`600 ${TILE*.38}px Rajdhani,sans-serif`;
    const maxW=w-TILE*1.6;
    const words=ans.split(' ');let line='',lines=[];
    for(const word of words){const t=line?line+' '+word:word;if(ctx.measureText(t).width>maxW&&line){lines.push(line);line=word;}else line=t;}
    if(line)lines.push(line);
    const lh=TILE*.42,th=(lines.length-1)*lh;
    lines.forEach((l,i)=>ctx.fillText(l,cx+w*.08,cy-th/2+i*lh));
  }
  ctx.textAlign='left';ctx.textBaseline='top';ctx.lineWidth=1;
}

function drawArrows(){
  const pulse=.55+.45*Math.sin(G.tick*.08);
  ctx.globalAlpha=pulse*.85;ctx.fillStyle='rgba(255,225,70,.95)';
  const arrows=[
    {x:18.5*TILE,y:7.4*TILE, dir:'up'},
    {x:18.5*TILE,y:21.5*TILE,dir:'down'},
    {x:7.4*TILE, y:14.5*TILE,dir:'left'},
    {x:29.5*TILE,y:14.5*TILE,dir:'right'},
  ];
  for(const a of arrows){
    const sz=TILE*.23;
    ctx.beginPath();
    if(a.dir==='up')   {ctx.moveTo(a.x,a.y-sz);ctx.lineTo(a.x-sz*.7,a.y+sz*.55);ctx.lineTo(a.x+sz*.7,a.y+sz*.55);}
    if(a.dir==='down') {ctx.moveTo(a.x,a.y+sz);ctx.lineTo(a.x-sz*.7,a.y-sz*.55);ctx.lineTo(a.x+sz*.7,a.y-sz*.55);}
    if(a.dir==='left') {ctx.moveTo(a.x-sz,a.y);ctx.lineTo(a.x+sz*.55,a.y-sz*.7);ctx.lineTo(a.x+sz*.55,a.y+sz*.7);}
    if(a.dir==='right'){ctx.moveTo(a.x+sz,a.y);ctx.lineTo(a.x-sz*.55,a.y-sz*.7);ctx.lineTo(a.x-sz*.55,a.y+sz*.7);}
    ctx.closePath();ctx.fill();
  }
  ctx.globalAlpha=1;
}

function drawPlayer(){
  const p=G.player;
  if(G.hitCooldown>0&&Math.floor(G.hitCooldown/5)%2===0)return;
  const r=p.size,x=p.x,y=p.y;
  const moving=Math.abs(p.vx)+Math.abs(p.vy)>0.3;
  ctx.fillStyle='rgba(0,0,0,.38)';ctx.beginPath();ctx.ellipse(x,y+r*.9,r*.6,r*.2,0,0,Math.PI*2);ctx.fill();
  const g=ctx.createRadialGradient(x-r*.2,y-r*.2,r*.08,x,y,r);
  g.addColorStop(0,'#ffffff');g.addColorStop(.55,'#ccd8f0');g.addColorStop(1,'#8899bb');
  ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(55,130,255,.78)';ctx.beginPath();ctx.ellipse(x,y-r*.05,r*.46,r*.35,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(180,225,255,.45)';ctx.beginPath();ctx.ellipse(x-r*.11,y-r*.17,r*.17,r*.09,Math.PI*.3,0,Math.PI*2);ctx.fill();
  if(moving){const sw=Math.sin(Date.now()*.014)*.35;ctx.strokeStyle='#aabbd4';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(x-r*.2,y+r*.7);ctx.lineTo(x-r*.1+sw*r,y+r*1.25);ctx.stroke();ctx.beginPath();ctx.moveTo(x+r*.2,y+r*.7);ctx.lineTo(x+r*.1-sw*r,y+r*1.25);ctx.stroke();}
}

function drawEnemy(en){
  const r=TILE*.39,bob=Math.sin(Date.now()*.0042+en.bob)*2.5;
  const x=en.x,y=en.y+bob;
  ctx.fillStyle='rgba(0,0,0,.28)';ctx.beginPath();ctx.ellipse(x,en.y+r*.85,r*.55,r*.18,0,0,Math.PI*2);ctx.fill();
  if(en.mode==='chase'){ctx.shadowColor=en.color;ctx.shadowBlur=14;}
  ctx.fillStyle=en.color;ctx.beginPath();ctx.arc(x,y,r,Math.PI,0,false);
  const base=y+r,wc=5;
  for(let i=0;i<=wc;i++){const wx=x+r*(1-i*2/wc);const wy=base+(i%2===0?5:-5)*Math.sin(Date.now()*.0048+i+en.bob);ctx.lineTo(wx,wy);}
  ctx.closePath();ctx.fill();ctx.shadowBlur=0;
  ctx.fillStyle='rgba(255,255,255,.92)';ctx.beginPath();ctx.arc(x-r*.28,y-r*.1,r*.19,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(x+r*.28,y-r*.1,r*.19,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#111';ctx.beginPath();ctx.arc(x-r*.26,y-r*.08,r*.09,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(x+r*.3,y-r*.08,r*.09,0,Math.PI*2);ctx.fill();
  if(en.mode==='patrol'){ctx.globalAlpha=.3;ctx.setLineDash([3,5]);ctx.strokeStyle=en.color;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,en.y,r+6,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUESTION SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUESTION PREVIEW (5-second pre-game display) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PREVIEW_SECS = 10;
let _previewTimer = null;

function showQuestionPreview(onDone) {
  const q = G.questions[G.qIndex];
  const total = G.questions.length;

  // Populate content
  document.getElementById('qpBadge').textContent = `Question ${G.qIndex + 1} of ${total}`;
  document.getElementById('qpQuestion').textContent = q.q;
  document.getElementById('qpA').textContent = q.a[0];
  document.getElementById('qpB').textContent = q.a[1];
  document.getElementById('qpC').textContent = q.a[2];
  document.getElementById('qpD').textContent = q.a[3];

  // Reset bar
  const bar = document.getElementById('qpBarFill');
  const label = document.getElementById('qpCountdown');
  bar.style.width = '100%';
  bar.style.transition = 'none';

  // Show overlay
  document.getElementById('questionPreview').classList.add('open');

  let remaining = PREVIEW_SECS;
  label.textContent = `Starting in ${remaining}...`;
  // Force reflow so the CSS transition fires properly
  bar.getBoundingClientRect();
  bar.style.transition = `width ${PREVIEW_SECS}s linear`;
  bar.style.width = '0%';

  if (_previewTimer) clearInterval(_previewTimer);
  _previewTimer = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(_previewTimer);
      _previewTimer = null;
      label.textContent = 'üöÄ GO!';
      setTimeout(() => {
        document.getElementById('questionPreview').classList.remove('open');
        onDone();
      }, 400);
    } else {
      label.textContent = `Starting in ${remaining}...`;
    }
  }, 1000);
}

function loadQuestion(){
  const q=G.questions[G.qIndex];
  document.getElementById('hudQuestion').textContent=q.q;
  document.getElementById('hudTopic').textContent='üéÆ '+G.topic.name.toUpperCase();
  document.getElementById('zoneA').textContent='A: '+q.a[0];
  document.getElementById('zoneB').textContent='B: '+q.a[1];
  document.getElementById('zoneC').textContent='C: '+q.a[2];
  document.getElementById('zoneD').textContent='D: '+q.a[3];
  G.timerLeft=settings.timerSecs;
  document.getElementById('hudTimer').textContent=settings.timerEnabled?'‚è± '+settings.timerSecs+'s':'‚è± ‚àû';
  updateHud();
}

function showAnswerOverlay(correct,zi,q){
  G.running=false;cancelAnimationFrame(G.animId);
  if(correct)G.correctCount++;
  const pct=Math.round(G.correctCount/G.questions.length*100);
  document.getElementById('ansIcon').textContent=correct?'‚úÖ':'‚ùå';
  document.getElementById('ansResultText').textContent=correct?'CORRECT!':'WRONG!';
  document.getElementById('ansResultText').className='ans-result-text '+(correct?'correct':'incorrect');
  document.getElementById('ansInfo').textContent=correct?`"${q.a[q.correct]}" is correct! Keep going!`:`You chose "${q.a[zi]}". The correct answer was "${q.a[q.correct]}".`;
  document.getElementById('nextQBtn').textContent=G.qIndex>=G.questions.length-1?'üèÜ See Results':'Next Question ‚Üí';
  const fill=document.getElementById('underFill');fill.style.width=pct+'%';fill.textContent=pct+'%';
  document.getElementById('hudUnderstanding').textContent='üß† '+pct+'%';
  document.getElementById('answerOverlay').classList.add('open');
}

function nextQuestion(){
  document.getElementById('answerOverlay').classList.remove('open');
  G.qIndex++;
  if(G.qIndex>=G.questions.length){showResult(true);return;}
  G.player.x=(PLAYER_SPAWN_COL+.5)*TILE;G.player.y=(PLAYER_SPAWN_ROW+.5)*TILE;
  G.player.vx=0;G.player.vy=0;
  G.enemies.forEach((en,i)=>{
    const sp=ENEMY_SPAWNS[i%ENEMY_SPAWNS.length];
    en.x=(sp.tc+.5)*TILE;en.y=(sp.tr+.5)*TILE;
    en.path=[];en.patrolPath=[];en.patrolIdx=0;en.mode='patrol';
  });
  G.phase='playing';G.patrolTimer=0;G.chaseStarted=false;
  G.spawnProtect=SPAWN_PROTECT;G.timerLeft=settings.timerSecs;
  loadQuestion();
  // Show preview for 5s, then start loop
  showQuestionPreview(()=>{
    G.running=true;G.lastTime=performance.now();
    G.animId=requestAnimationFrame(loop);
  });
}

function showResult(ok){
  G.running=false;cancelAnimationFrame(G.animId);
  document.getElementById('answerOverlay').classList.remove('open');
  const pct=Math.round(G.correctCount/G.questions.length*100);
  document.getElementById('resultTrophy').textContent=pct===100?'üèÜ':pct>=60?'üéâ':'üí™';
  document.getElementById('resultHeadline').textContent=pct===100?'PERFECT SCORE!':pct>=60?'WELL DONE!':'KEEP PRACTICING!';
  document.getElementById('resultPct').textContent=pct+'%';
  document.getElementById('rTopic').textContent=G.topic.name;
  document.getElementById('rCorrect').textContent=G.correctCount;
  document.getElementById('rTotal').textContent=G.questions.length;
  document.getElementById('rLives').textContent=Math.max(0,G.lives)+' / '+G.maxLives;
  showScreen('resultScreen');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startGame(){
  if(!selectedTopicId){alert('Please select a topic first!');return;}
  const topic=appData.topics.find(t=>t.id===selectedTopicId);
  if(!topic||!topic.questions.length){alert('This topic has no questions. Add some in Manage Topics.');return;}
  if(!initGame())return;
  showScreen('gameScreen');
  canvas=document.getElementById('gameCanvas');
  canvas.width=CW;canvas.height=CH;
  ctx=canvas.getContext('2d');
  loadQuestion();
  G.keys={};
  document.onkeydown=e=>{G.keys[e.code]=true;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))e.preventDefault();};
  document.onkeyup=e=>{G.keys[e.code]=false;};
  let ts=null;
  canvas.ontouchstart=e=>{ts={x:e.touches[0].clientX,y:e.touches[0].clientY};e.preventDefault();};
  canvas.ontouchmove=e=>{if(!ts)return;const dx=e.touches[0].clientX-ts.x,dy=e.touches[0].clientY-ts.y;G.player.vx+=dx*.22;G.player.vy+=dy*.22;ts={x:e.touches[0].clientX,y:e.touches[0].clientY};e.preventDefault();};
  canvas.ontouchend=()=>ts=null;
  // Show question preview for 5s, THEN start the game loop
  showQuestionPreview(()=>{
    G.running=true;G.lastTime=performance.now();G.phase='playing';
    G.animId=requestAnimationFrame(loop);
  });
}

/* INIT */
renderMenu();
if(!selectedTopicId&&appData.topics.length)selectedTopicId=appData.topics[0].id;
setTimeout(()=>{const c=document.querySelectorAll('.topic-card');if(c[0])c[0].classList.add('selected');},50);
</script>
</body>
</html>